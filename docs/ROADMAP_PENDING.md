# 残課題・今後のロードマップ (Pending Tasks & Roadmap)

現在の開発状況（Phase 2-3完了時点）に基づき、配信者向けVSTホストとして「止まらない・使いやすい」を実現するための優先順位付きロードマップです。

## 1. 必須機能 (Prioritized Must-Haves) 🛑

何よりもまず実装すべき機能群です。これらが欠けていると実用性や安定性に致命的な問題があります。

### **A. プラグイン内部状態の保存 (State Persistence) [DONE]**
- **現状**: アプリ再起動時にプラグインのパラメータ（ツマミの位置など）が初期化されてしまい、毎回設定し直す必要がある。
- **目標**: 再起動しても、前回の続きからすぐに配信を始められるようにする。
- **タスク**:
    - [x] **State Collection**: `audio_engine` 終了時または定期的に、各プラグインの `get_state()` (Chunk Data) を取得する。
    - [x] **JSON Store**: 以下のJSON形式で構成全体を保存する（将来のプリセット機能の基盤）。
        ```json
        {
          "version": "1.0",
          "plugins": [
            {
              "id": "unique_id",
              "path": "path/to/plugin.vst3",
              "enabled": true,
              "state_chunk": "base64_string..."
            }
          ]
        }
        ```
    - [x] **Restore Logic**: 起動時に保存されたJSONを読み込み、プラグインをロードした後 `set_state()` でパラメータを復元する。

### **B. クラッシュ防止・安全装置 (Safety Guards) [DONE]**
- **現状**: チャンネル数不一致（ASIO 8ch vs Plugin 2ch）や、不正なバッファアクセスで `audio_engine` が即死するリスクがある。
- **目標**: 「音が出ない」ことはあっても「アプリが落ちる」ことを防ぐ。
- **タスク**:
    - [x] **Auto Downmix / Channel Matching**: オーディオエンジンのバッファ処理において、デバイスのチャンネル数がプラグインの想定を超える場合、強制的に安全なチャンネル数（Stereo）で処理するか、ダウンミックスを行うことで `index out of bounds` パニックを防ぐ。
    - [x] **Plugin Scan Validation**: 起動時スキャンでロードに失敗するプラグインをブラックリスト化し、二度とロードしない仕組み。

## 2. UI/UX 改善 (Core UX Improvements) 🎨

配信者が安心して使える画面作りです。

### **入出力レベルメーターの分離 (Pre/Post Metering) [DONE]**
- **現状**: 音がどこで止まっているのか、プラグインでどれくらい音が変わったのかが分からない。
- **タスク**:
    - [x] **Pre-FX Meter**: プラグイン入力前のドライ音量を表示。マイク入力が来ているかの確認用。
    - [x] **Post-FX Meter**: 最終出力音量を表示。配信に乗る音量の確認用。
    - [x] **Clip Indicator**: 0dBを超えたら赤く点灯し続けるピークインジケーター。

### **プラグインエディタ管理 [DONE]**
- **現状**: 配信操作中、プラグイン画面が裏に隠れてしまい調整しにくい。
- **タスク**:
    - [x] **Always on Top**: プラグインエディタを常に最前面に表示するオプション。

## 3. 将来機能・差別化 (Differentiation / v1.1+) 🚀

基本機能が安定した後に実装する機能です。

### **プリセット管理と OBS連携**
- **現状**: 「歌枠」「雑談」などの設定切り替えが手動で大変。
- **目標**: シーンに合わせて自動で音が切り替わる「配信オートメーション」。
- **タスク**:
    - [x] **Preset Manager**: 上記のJSON保存機能を拡張し、名前付きで複数の設定を保存/読込できるようにする。
    - [x] **OBS WebSocket**: OBSのシーン切り替えイベントを監視し、シーン名に紐づいたプリセットを自動ロードする。

### **高度なルーティング**
- **現状**: 1/2ch 固定。
- **タスク**:
    - [ ] 入出力チャンネルの任意割り当て（Input 3/4 -> Output 1/2 等）。

### **プロセス分離 (Process Isolation / Sandbox)**
- **現状**: 1つのプラグインがクラッシュするとエンジン全体が落ちる。
- **タスク**:
    - [ ] `audio_engine` のさらに子プロセスとしてプラグインをホストし、IPCでオーディオを送受信する（難易度高・レイテンシ注意）。
    ※まずは「B. クラッシュ防止」で対応し、これが必要かどうかは後で判断。

---

## 開発優先順位 (Recommended Priority)

1. **State Persistence** (これがないと始まらない)
2. **Safety Guards** (落ちてはいけない)
3. **Pre/Post Metering** (見えないと不安)
4. **Preset Manager** (設定保存の延長)
5. **OBS Integration** (差別化)
