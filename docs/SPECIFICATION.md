# VSTHost 機能仕様書

## 1. ドキュメント方針
このドキュメントは、VSTHostアプリケーションの機能およびアーキテクチャの仕様を定義するものである。
開発はこの仕様に従って行う必要がある。実装の詳細によって動作の変更が必要となる場合は、まずこのドキュメントを更新しなければならない。

### 粒度の定義
*   **機能レベル**: ユーザーが直面する機能やシステムの振る舞いを記述する。
*   **インタラクションレベル**: 入力、出力、およびUIの状態を定義する。
*   **アーキテクチャレベル**: コンポーネントの責務とデータフロー（IPCメッセージ、イベント）を定義する。
*   **除外事項**: インターフェースにとって重要でない限り、具体的なコード実装の詳細（クラス名、関数のシグネチャ）は除外する。

### サポートOS
*   **ターゲット**: Windows 10/11 (x64) のみ。
*   **対象外**: macOS, Linux。

---

## 2. システムアーキテクチャ
### 2.1. ハイブリッドアーキテクチャ (サイドカーパターン)
*   **Frontend**: Tauri (React/TypeScript) がUIと状態管理を担当。
*   **Backend (Main)**: Tauri (Rust) がブリッジおよびプロセスマネージャーとして動作。
*   **Audio Engine (Sidecar)**: 独立したプロセス (`audio_engine.exe`) がリアルタイムオーディオ処理とVST3ホスティングを担当。
    *   **理由**: UIをオーディオのクラッシュから切り離し、独立したASIOスレッド管理を可能にするため。
    *   **通信**: 標準入出力 (Stdin/Stdout) を使用したJSON-RPC 2.0スタイルのメッセージ。

### 2.2. IPCプロトコル仕様
*   **フォーマット**: JSON-RPC 2.0 互換 (最小限のサブセット)。
*   **フレーミング**: 改行 (`\n`) 区切り。各行が完全なJSONオブジェクトとなる。
    *   **ペイロードエンコーディング**: バイナリデータ（例: `getState` からのVST3状態）は、**改行なし**でBase64エンコードする必要がある（標準Base64、RFC 2045の76文字制限による折り返しなし）。
*   **スキーマ**:
    *   **リクエスト**: `{ "jsonrpc": "2.0", "method": "string", "params": { ... }, "id": number/string }`
    *   **レスポンス**: `{ "jsonrpc": "2.0", "result": { ... }, "id": number/string }`
    *   **エラー**: `{ "jsonrpc": "2.0", "error": { "code": number, "message": "string" }, "id": number/string }`
    *   **通知 (イベント)**: `{ "jsonrpc": "2.0", "method": "string", "params": { ... } }` (`id` なし)
*   **タイムアウト**:
    *   **リクエストのみ**に適用される（`id` を持つもの）。通知は投げっ放し（fire-and-forget）。
    *   デフォルト: 5000ms。
    *   タイムアウト時、バックエンドはフロントエンドにコード `-32001` (Timeout) のエラーを返す。
*   **エラーコード** (実装定義エラー用のJSON-RPC予約範囲 -32000 ～ -32099):
    *   `-32001`: タイムアウト
    *   `-32002`: エンジンクラッシュ / 利用不可
    *   `-32003`: デバイス初期化失敗

---

## 3. 機能

### 3.1. オーディオデバイス管理
**目標**: ユーザーがオーディオドライバ (ASIO/WASAPI) を選択・設定できるようにする。

*   **オーディオデバイス管理ロジック**:
    *   **ASIO**:
        *   **概念**: 単一ドライバモデル。選択された1つのドライバが入出力の両方を処理する。
        *   **選択**: ユーザーは**1つ**のASIOドライバを選択する。
        *   **チャンネル**: 初期リリースでは、最初のステレオペア（Input 1/2 -> Output 1/2）をデフォルトとする。
    *   **WASAPI**:
        *   **概念**: 独立デバイスモデル。入力と出力は別々のエンティティ。
        *   **選択**: ユーザーは**入力デバイス**と**出力デバイス**を個別に選択する。
        *   **チャンネル**: デバイスのデフォルトのステレオペアをデフォルトとする。

*   **初期化パラメータ**:
    *   **サンプルレート優先順位**:
        1.  48000 Hz (推奨)
        2.  44100 Hz (フォールバック)
        3.  デバイスのデフォルト (最終手段)
        *   推奨レートがサポートされていない場合は、警告をログに出力し、デバイスのデフォルトを使用する。
    *   **バッファサイズ**: デバイスのデフォルト（通常 256-512 サンプル）。ユーザー設定は計画されているが、初期リリースには含まれない。
    *   **チャンネル**: ステレオ (2ch) I/O のみ。
    *   **排他モード**:
        *   **ASIO**: 性質上、常に排他モード。
        *   **WASAPI**: 共有モード（デフォルト）。排他モードオプションは初期リリースの対象外。

*   **オーディオ信号フロー**:
    *   **入力キャプチャ**: 選択された入力デバイス（またはASIO入力チャンネル）からのオーディオをキャプチャする。
    *   **処理**: キャプチャされたオーディオはVST3プラグインチェーンを通過する。
    *   **出力再生**: 処理されたオーディオは選択された出力デバイス（またはASIO出力チャンネル）に送信される。
    *   **データ転送**: 入力 -> 出力はロックフリーのリングバッファを介して同期され、どちらのオーディオスレッドのブロックも回避する。

*   **デバイス優先順位とフォールバック**:
    1.  ユーザー設定（`localStorage` に保存）。
    2.  ASIOドライバ（利用可能な場合）。
    3.  WASAPI デフォルトデバイス。
    *   保存されたデバイスが見つからない場合は、警告を表示してフォールバックする。

*   **ホットスイッチング (ストリームアクティブ時)**:
    *   **許可**: オーディオストリームの実行中でもホスト/入力/出力を切り替え可能。
    *   **動作**:
        1.  UIがデバイス変更を要求。
        2.  エンジンが `Restarting` 状態に移行。
        3.  **プラグインチェーンの無効化**: 各プラグインに対し `setProcessing(false)` -> `setActive(false)`。
        4.  出力をミュート -> ストリーム停止。
        5.  新しい設定（新しいサンプルレート/バッファサイズ）でエンジンを再初期化。
        6.  **プラグインチェーンの再有効化**: 各プラグインに対し `setActive(true)` -> `setProcessing(true)`。（サンプルレートが変更された場合は `setupProcessing` を再呼び出し）。
        7.  成功時: ストリーム開始 -> ミュート解除 -> UIに通知。
        8.  失敗時: 前の設定へのロールバックを試行。ロールバックも失敗した場合は、エンジンを停止し致命的エラーを報告。
    *   **安全性**: すべての再初期化処理は、オーディオスレッドではなく制御スレッドで実行しなければならない。

### 3.2. VST3プラグイン管理
**目標**: VST3プラグインのスキャン、ロード、およびチェーン接続。

*   **スキャン**:
    *   **範囲**: 標準的なシステムパス (`C:\Program Files\Common Files\VST3`)。
    *   **責務**: **Audio Engine Sidecar** がスキャンを実行する。メインアプリはIPC経由で要求する。これにより、メインUIプロセスをクラッシュから隔離する。
    *   **安全性**:
        *   **タイムアウト**: 各プラグインのスキャン試行には5秒のタイムアウトを設定。超過した場合、そのプラグインを「スキャン失敗」としてマークし続行する。
        *   **ブロックリスト (計画中)**: クラッシュを引き起こすプラグインのハッシュを保存し、将来のスキャンでスキップする。

*   **ホスティング (ラック)**:
    *   **ネゴシエーション**:
        *   バス構成: マスターバス (ステレオ) <-> プラグインメインバス (ステレオ)。
        *   プラグインがモノラルのみをサポートする場合、ホストはエラーを報告する（初期リリースではステレオ必須）。
        *   レイテンシ補正は初期リリースの対象外。

*   **ライフサイクル** (VST3標準順序):
    *   **ロード**:
        1.  `createInstance` (Factoryより)。
        2.  `initialize` (IComponent)。
        3.  `setBusArrangements` (IAudioProcessor)。
        4.  `setupProcessing` (IAudioProcessor, サンプルレート/ブロックサイズ指定)。
        5.  `setActive(true)` (IComponent)。
        6.  `setProcessing(true)` (IAudioProcessor)。
    *   **アンロード**:
        1.  `setProcessing(false)` (IAudioProcessor)。
        2.  `setActive(false)` (IComponent)。
        3.  `terminate` (IComponent)。
        4.  COMポインタの解放。
        5.  DLLのアンロード (ライブラリドロップ)。
*   **プラグインID**: ロード時に生成される一意の文字列（例: `"plugin_{uuid}"`）。ラック内のプラグインを参照するために使用される。

### 3.3. レベルメータリング
**目標**: マスター出力のリアルタイムオーディオレベルを可視化する。

*   **仕様**:
    *   **指標**: ピークレベル（オーディオバッファの絶対ピーク）、リニアスケール 0.0 ～ 1.0。
    *   **バリスティクス**:
        *   **アタック**: 即時（バッファの真のピークをキャプチャ）。
        *   **リリース**: フロントエンドのアニメーションによるスムージング（視覚的な快適さのため約300msの減衰）。
    *   **IPCイベント名**: `audio-level` (固定、エンジンとフロントエンド双方で使用)。
    *   **データパス**: リングバッファ (オーディオスレッド -> エンジンメインループ) -> IPCイベント `{ "method": "audio-level", "params": { "left": f32, "right": f32 } }` -> Tauriバックエンドが `audio-level` イベントを発行 -> Frontend。
    *   **更新レート**: ~20 FPS (50ms間隔)。

### 3.4. 状態の永続化 (計画中)
**目標**: ラックの状態全体を保存/ロードする。

*   **ファイルフォーマット**: バイナリデータを含むJSON。
    *   `version`: スキーマバージョン（例: `1`）。
    *   `plugins`: 以下の配列:
        *   `path`: VST3ファイルへの絶対パス。
        *   `classId`: 識別のためのVST3クラスID（GUID文字列）。
        *   `name`: 表示名（UI/デバッグ用）。
        *   `state`: Base64エンコードされたバイナリ状態（`getState`より、**改行なし**）。
    *   `rackOrder`: 信号チェーンの順序を定義するプラグインIDの配列。
*   **動作**:
    *   **保存**: プラグインを反復 -> `getState` -> Base64エンコード -> JSON構築 -> ファイルへ書き込み。
    *   **ロード**: JSON読み込み -> バージョン検証 -> ラッククリア -> 各プラグインエントリについて: パス/クラスIDでロード -> デコードされたバイナリで `setState`。
    *   **エラー処理**: プラグインが見つからないかロードに失敗した場合、そのプラグインをスキップし、警告を表示して他（のロード）を継続する。

---

## 4. UI/UX ガイドライン
*   **テーマ**: サイバースレート (ダークモード)。
*   **入力**:
    *   キーボードショートカット（スペースでオーディオ切り替え、Ctrl+Sで設定保存）。
    *   スクリーンリーダー用アクセシビリティラベル（計画中）。

---

## 5. 対象外 (初期リリース)
*   **VST3 プラグイン UI (エディタ)**: プラグインが提供するUIの埋め込み (`IPlugView`) は**含まれない**。ホストは汎用的なパラメータリストのみを提供する。
*   **オートメーション**: パラメータオートメーションレーンなし。
*   **MIDI In/Out**: 当面はオーディオ処理のみ。
*   **レイテンシ補正**: チェーン内のプラグインレイテンシは補正されない。
*   **WASAPI 排他モード**: WASAPIは共有モードのみ。

