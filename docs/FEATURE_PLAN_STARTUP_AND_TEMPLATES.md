# VSTHost 付加価値機能 計画（自動起動 / テンプレ / セーフモード）

## 1. 目的（ユーザー目線）
「VSTホストを探してたまたま辿り着いた配信者/実況者」が、**迷わず・事故らず・すぐ配信に使える**状態まで到達できることを最優先にする。

特に初見ユーザーが詰まりやすいポイントは以下。

- 毎回起動するのが面倒（使い続けない）
- チェーン設計が難しい（何を入れればいいか分からない）
- 変更が怖い（クラッシュ/無音/爆音などの事故）

本ドキュメントでは、上記を直接解消する **(A) Windows自動起動**、**(B) テンプレ/ウィザード**、**(C) セーフモード復旧** を具体化する。

## 2. 前提（調査結果 / 現状の土台）

### 2.1 アーキテクチャ
- Tauri v2 + Rust + React/TypeScript。
- オーディオ処理とVST3ホスティングは別プロセス `audio_engine.exe`（サイドカー）で実行。
  - 重要: プラグインスキャンは `plugin_scanner.exe` サブプロセスで実施（メインプロセスでスキャンしない）。

参考実装（既存）:
- エンジンクラッシュ検知とイベント通知: `vst-host/src-tauri/src/audio.rs`
  - stdout監視が終了したら `audio-error` イベントをemitして、保留中コマンドを中断している。
- プリセット保存/読込: `vst-host/src-tauri/src/vst_host/presets.rs` と `vst-host/src/hooks/usePlugins.ts`
- システムVST3スキャン + ブラックリスト: `vst-host/src-tauri/src/vst_host/scanner.rs` と `vst-host/src-tauri/src/vst_host/blacklist.rs`

### 2.2 既存UI要素（再利用できる）
- 設定UI（タブ構成）: `vst-host/src/components/features/AudioSettings/AudioSettingsModal.tsx`
- 初期セットアップ支援: `vst-host/src/components/features/SetupWizard/SetupWizardModal.tsx`
- プリセット管理: `vst-host/src/components/features/Presets/PresetManagerModal.tsx`
- プラグイン一覧/追加導線: `vst-host/src/components/features/Plugins/PluginBrowserModal`（`App.tsx` から利用）

## 3. 今回のスコープ

### 3.1 追加する機能（MVP）
1) **Windowsログイン時の自動起動（起動するだけ）**
2) **テンプレ（同梱なし）を使ったチェーン作成**
3) **セーフモード復旧（クラッシュ時に最低限戻れる）**

### 3.2 明確にやらない（MVPの非目標）
- トレイ常駐/バックグラウンド起動（将来検討）
- 自動起動と同時に音声処理を自動開始（事故リスクが高いため別トグルにする）
- 他社プラグインの同梱（ライセンス/再配布コストが高い）
- LUFS自動合わせ/本格ダッキングなど重めのDSP（ロードマップ項目としては残す）

## 4. 機能仕様（案）

## 4.1 Windows 自動起動（ログイン時起動）

### 4.1.1 UX
- 設定画面にトグルを追加:
  - `Windowsログイン時に自動起動する`
- ONにすると、次回ログイン時にアプリが起動する。
- ON/OFF 直後に結果をトーストで通知（成功/失敗と簡単な理由）。

推奨（将来拡張を見据えた設計）:
- 自動起動で起動された場合は `--autostart` 引数を付ける。
  - 現時点ではUI上の挙動を変えなくてもよいが、後から「自動起動時は“音声を開始しない”」等の制御に使える。

### 4.1.2 実装方式の比較（実現性）
Windowsのみを前提に、以下のいずれか。

**方式A: レジストリ（HKCU\\...\\Run）**
- 内容: `HKCU\Software\Microsoft\Windows\CurrentVersion\Run` に値を追加/削除する。
- 長所:
  - 管理者権限不要（HKCUで完結）
  - 依存が増えにくい（小さなRust実装で完結）
- 短所:
  - ポータブル運用で exe の場所を移動すると古いパスが残る可能性

**方式B: `tauri-plugin-autostart` の利用**
- 長所:
  - クロスプラットフォームに拡張しやすい
- 短所:
  - 依存追加・設定追加・将来的な追従が必要
  - Tauri v2のcapability/permission要件を別途管理する必要がある

本プロジェクトは当面Windowsのみ・小さく確実に入れたいので、MVPは **方式A** を推奨。

### 4.1.3 バックエンドI/F（案）
フロントエンドから `invoke` で呼べるコマンドを追加する。

- `get_autostart_status() -> { enabled: boolean, method: "registry", command?: string }`
  - 現在のレジストリ値を読み、ON/OFFを返す。
  - `command` はデバッグ/サポート用に実際の値を返してよい（UIには表示しなくてもよい）。
- `set_autostart_enabled(enabled: boolean) -> void`
  - `enabled=true` でレジストリへ書き込み、`false` で削除。

### 4.1.3.1 想定変更箇所（粒度: ファイル単位）
- Rust:
  - `vst-host/src-tauri/src/lib.rs` に `#[tauri::command]` を追加（`invoke_handler` へ登録）
  - 実装は `vst-host/src-tauri/src/autostart.rs` のように分離（レジストリアクセスを1箇所に閉じ込める）
  - 依存追加（どちらか）:
    - `winreg` crate を追加する、または
    - 既存の `windows` crate に `Win32_System_Registry` feature を追加する
- Frontend:
  - `vst-host/src/api/autostart.ts`（新規）: `invoke("get_autostart_status")` / `invoke("set_autostart_enabled")`
  - `vst-host/src/components/features/AudioSettings/AudioSettingsModal.tsx`: トグルUI追加（“一般/起動” など）

### 4.1.4 レジストリ仕様（案）
- キー: `HKCU\Software\Microsoft\Windows\CurrentVersion\Run`
- 値名: `vst-host`（`productName` か `identifier` 由来の固定名）
- 値データ: `"C:\...\vst-host.exe" --autostart`
  - スペースを含むパスに備え、必ずクォートする。

### 4.1.5 テスト/検証（案）
- 手動:
  - トグルON → レジストリ値作成を確認 → Windowsログオフ/ログインで起動すること
  - トグルOFF → 値削除を確認 → ログインしても起動しないこと
- 自動（可能なら）:
  - `get_autostart_status` の「値あり/なし」の分岐をユニットテスト（レジストリアクセスの抽象化が必要）

### 4.1.6 リスクと対策
- 旧パスが残る: 次回起動時に `enabled=true` なら、値が現exeと一致しない場合に自動修復する（任意）。
- セキュリティ: UIから任意コマンドを設定できる設計にしない（値は常に `current_exe + 固定引数` で生成）。

---

## 4.2 テンプレ / ウィザード（プラグイン同梱なし）

### 4.2.1 ねらい
テンプレで「何をどう並べるか」を決め、ユーザー環境にあるプラグインを割り当てることで、**“初期の迷子”**を減らす。

重要: 本MVPでは **プラグイン本体は同梱しない**（将来の有償化/配布形態変更でも安全に継続できるため）。

### 4.2.2 既存機能との位置付け
- 既存の「プリセット」は **具体的なプラグインパス + 状態（Base64）** を保存する。
  - ＝環境依存が強いが、ユーザーにとっては再現性が高い。
- 新しい「テンプレ」は **役割（Role）中心**。
  - ＝初見導線に強いが、プラグインごとのパラメータ状態は基本的に扱わない（初期状態でロード）。

### 4.2.3 テンプレ定義（データモデル案）
テンプレはアプリ同梱のJSONとして持ち、必要に応じて将来ユーザー定義テンプレを追加できる形にする。

```ts
type TemplateRole =
  | "noise_gate"
  | "compressor"
  | "deesser"
  | "eq"
  | "limiter";

type ChainTemplate = {
  id: string;
  name: string;
  description: string;
  slots: Array<{
    role: TemplateRole;
    required: boolean;
    // 自動割当を助けるためのヒント（曖昧一致）
    preferred?: Array<{ vendor?: string; nameIncludes?: string }>;
    notes?: string; // 例: 「まずはThresholdを下げて…」
  }>;
};
```

※ `preferred` は「同梱しない」方針と矛盾しない（ユーザー環境に存在するプラグインを“候補として提示するだけ”）。

### 4.2.4 役割割り当て（マッチング）方針
課題: 現状のスキャン結果には「カテゴリ/タイプ」の情報がない（`name/vendor/version/path` が中心）。

MVPの割当は段階的にする。

**MVP（確実・最小）**
- `preferred` をヒューリスティックに使って「候補を先頭に出す」程度に留める。
- 最終的な割当はユーザーがドロップダウンで確定する。

**v1（付加価値）**
- ユーザーが手持ちプラグインに「役割タグ」を付けられるようにする。
  - 例: `C:\...\Foo.vst3` に `compressor` を付与
  - 設定は `app_config_dir` に `plugin_tags.json` 等で保存（パス→role配列）。
- テンプレ適用時に role でフィルタした候補を提示し、自動割当の精度を上げる。

### 4.2.5 UIフロー（案）
導線は2通り用意する（どちらも既存UIを流用しやすい）。

**導線A: セットアップウィザード内に「テンプレで始める」**
1. 用途を選択（雑談/ゲーム/歌）
2. 各roleスロットに対して候補を提示 → 未割当は選ばせる
3. 適用（チェーンを生成）
4. 最後に「プリセットとして保存しますか？」（任意）

**導線B: プリセット管理と並列に「テンプレ」管理モーダル**
- 「テンプレから作る」→割当→適用→必要なら保存

### 4.2.6 適用時の挙動（安全側）
- デフォルトは「現在のチェーンを破棄して適用」だが、必ず確認ダイアログを出す。
- 適用中にプラグインロード失敗が起きても「他スロットは継続」し、最後に結果サマリを出す。
- 状態（パラメータ）は基本復元しない（初期状態ロード）。
  - 代わりにテンプレの `notes` で初期調整手順を案内する。

### 4.2.7 想定変更箇所（粒度: コンポーネント/モジュール単位）
- Frontend:
  - `vst-host/src/templates/chainTemplates.ts`（新規）: 同梱テンプレ定義
  - `vst-host/src/components/features/Templates/TemplateWizardModal.tsx`（新規）または `SetupWizardModal.tsx` 拡張
  - `vst-host/src/hooks/usePlugins.ts`: テンプレ適用用のヘルパ（「全削除→順にload」「失敗の収集」など）
- Backend:
  - MVPは不要（テンプレは基本フロントで完結できる）
  - v1以降で `plugin_tags.json` を `app_config_dir` に保存する場合は、読み書きコマンドを追加するか、フロントで `localStorage` 管理するかを決める（同期/移行の方針が必要）

---

## 4.3 セーフモード復旧（クラッシュしても戻れる）

### 4.3.1 現状の強み（調査結果）
すでにエンジンクラッシュはバックエンドで検知でき、`audio-error` がフロントに飛ぶ。
これは「復旧導線」を作るうえで重要な土台。

### 4.3.2 MVPの到達点
「テンプレ適用やプラグイン追加の途中で落ちても、次回起動時にユーザーが自力で戻れる」状態を作る。

MVP案:
- アプリは以下をローカルに保存する（最低限）:
  - 直近のチェーン（プラグインパス一覧と順序）
  - 直近操作ログ（例: “最後に追加したプラグインパス”）
- `audio-error` を受けたら、UIに「エンジンが停止しました。復旧しますか？」を出す。
  - 復旧ボタン: エンジン再起動 → 保存済みチェーンを復元（必要なら最後に追加した1つをスキップする）
  - 失敗したら「セーフモードで起動（すべて無効化）」にフォールバック

### 4.3.3 具体的な復旧戦略（段階）
**段階1（最小）**
- 「最後に追加したプラグインをスキップ」するだけの復旧

**段階2（強い）**
- クラッシュ頻発プラグインを“実行時ブラックリスト”へ入れて自動スキップ
  - 既存のスキャンブラックリストとは別管理（スキャンは通るが実行時に落ちるケースがある）

### 4.3.4 リスクと対策
- 誤検知（たまたまOS終了など）: 「クラッシュ扱い」でもユーザーに選択肢を出すだけなら実害は小さい。
- 状態復元の安全性: VSTの `setState` はクラッシュ要因にもなるため、復旧では「まずは状態なしで復元→ユーザーが必要なら手動でプリセットロード」も選べるようにする（将来）。

### 4.3.5 想定変更箇所（粒度: フロー単位）
- Frontend:
  - `vst-host/src/App.tsx`: `audio-error` の受信時に「復旧UI（モーダル/トースト+ボタン）」を出す
  - `vst-host/src/hooks/usePlugins.ts`: 「直近操作（最後に追加したpath）」の追跡と、復旧時の“スキップ”ロジック
- Backend（必要なら）:
  - 実行時ブラックリストを `app_config_dir` に保存する場合は、`vst-host/src-tauri/src/vst_host/blacklist.rs` と同様の仕組みを“runtime用”に追加
  - ただしMVPはフロント側の「最後の追加をスキップ」で成立しやすい（まずは小さく入れる）

---

## 5. ロードマップ（提案）

### MVP（まず利用者増に効く）
- Windowsログイン時自動起動（起動のみ）
- テンプレ適用（同梱なし・手動割当中心）
- セーフモード復旧（最後の追加をスキップできる）

### v1（“便利”が体感できる）
- プラグイン役割タグ付け + 自動割当の精度向上
- テンプレを「プリセットとして保存」導線の強化（初見→定着）
- 簡易ヘルス表示（ドロップアウト回数、エンジン再起動回数など）

### v2（音が良くなる/配信事故が減る）
- ラウドネス目標（簡易版: Peak/RMS → 本格: LUFS）
- OBS連携の強化（シーン切替、ソース音量調整など）

## 6. 実装開始前の確認事項（認識齟齬を潰す）
1) 自動起動トグルは「起動のみ」でOKか（音声処理の自動開始は別トグルとして後回しでよいか）
2) テンプレは「役割並び + 初期調整ガイド」で十分か（プラグイン状態の配布はしない）
3) テンプレ適用は「現在のチェーンを置き換え」が基本でよいか（追加適用も必要か）
4) セーフモード復旧は「最後の追加をスキップ」から始めてよいか（より強いブラックリストはv1以降）
