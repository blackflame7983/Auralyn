# 機能提案書: ノイズ抑制と音質ステータス表示（改訂版）

## 1. ワンクリック・ノイズ抑制機能 (One-Click Noise Suppression)

### 概要
VSTプラグインを使わなくても、アプリ本体だけで「ON/OFF可能な簡易ノイズ抑制」を提供します。  
ライト配信者が最初の一歩として使えることを重視します。

### 技術的アプローチ
- **候補ライブラリ**: `nnnoiseless` (Rust, RNNoise系)
  - 音声向けの軽量ノイズ抑制として有力。
  - `src-tauri/Cargo.toml` へ依存追加可能。
- **実装前提**
  - RNNoise系は 48kHz / 固定フレーム（480 samples）前提。
  - 現行エンジンの可変バッファサイズと整合させるため、フレームアダプタ（リングバッファ）が必要。

### 実装場所
- **バックエンド (`audio_engine`)**
  - 入力ストリーム受信直後〜VST処理前の区間でノイズ抑制を実行。
  - 既存の入力リサンプル経路との責務分離を明確化する（どこで48k化するかを固定）。

### 制限事項・課題
- **サンプリングレート**
  - 44.1kHz設定時は内部48kHz変換が必要。
- **リアルタイム安全性**
  - オーディオコールバック内で追加アロケーションを避ける設計が必須。
  - CPU余裕が少ない環境では、抑制強度を落とす/自動OFFするフェイルセーフを検討。

### UIイメージ
- ヘッダーまたは入力ゲイン付近に `Noise Reduction` トグルを配置。
- 状態表示は `OFF / LOW / HIGH` の3段階を候補（初期は `LOW` 推奨）。

---

## 2. 音質・処理ステータス通知 (Signal Quality/Integrity Indicator)

### 概要
「今どの程度処理しているか」「どれだけ遅延が増えているか」をユーザーに明示し、調整しやすさを上げます。

### 提案コンセプト: "Signal Integrity Monitor"
単なる警告ではなく、**無加工の価値**と**加工の代償（遅延/負荷）**を同時に見せる設計にします。

### 具体的な実装案

#### A. 3状態ステータスランプ（推奨）
- **表示状態**
  - **🟢 PURE**: VST無効、ノイズ抑制もOFF（最小処理）
  - **🔵 CLEAN**: ノイズ抑制ON、VST無効（軽処理）
  - **🟡 FX**: 有効なVST処理あり（加工中）
- **注意**
  - 文言は「追加処理遅延ほぼなし（I/O遅延は別途存在）」とし、ゼロ遅延誤認を避ける。

#### B. レイテンシ表示（分解表示）
- **表示形式（例）**
  - `Base I/O: 12.3ms`
  - `FX Added: 3.0ms`
  - `Total: 15.3ms`
- **現状と拡張**
  - `Base I/O` は既存の推定式で表示可能。
  - `FX Added` は将来拡張（VSTの `get_latency_samples` 集計）で実測ベース化。

#### C. Glitch/Jitter 警告
- **表示**
  - 一定時間内にグリッチ発生時、メーター枠を一瞬点灯、または `⚡` アイコン表示。
- **前提**
  - 現状の `EngineRuntimeStats` には該当項目が未公開のため、IPC拡張が必要。

### 推奨プラン
今回は **A（3状態ランプ）+ B（分解遅延表示）** を優先し、Cは統計API拡張後に段階導入します。

---

## 3. 実装に向けた差分整理

### 現状で実装済み/利用可能
- エンジン統計API（`activePluginCount`, `pendingUnloadCount`, `burnedLibraryCount`）
- グローバルバイパス操作
- I/O理論遅延の表示ロジック（設定画面・デバイス表示）

### 追加実装が必要
1. **統計拡張**
   - `enabledPluginCount`
   - `globalBypass`
   - `maxJitterUs`
   - `glitchCount`
2. **VST遅延集計**
   - `get_latency_samples` を `VstProcessor` 側で取得可能にし、合算値をランタイム統計へ反映。
3. **ノイズ抑制トグル**
   - エンジンコマンド追加（ON/OFF、必要なら強度）。
   - フロントからの操作と状態同期。

---

## 4. 今後の進め方 (Next Steps)

1. **仕様確定**
   - ステータス3状態の判定条件を確定（PURE/CLEAN/FX）。
   - 遅延表示の定義を確定（推定値と実測値の表示ルール）。
2. **実装フェーズ**
   - Phase 1: ステータスランプ + Base I/O表示整備
   - Phase 2: VST遅延集計 + Total表示
   - Phase 3: ノイズ抑制（`nnnoiseless`）導入
3. **検証**
   - 44.1k / 48k 両設定で音切れ・負荷・遅延表示の整合性を確認。
   - 低スペック環境でのフォールバック動作を確認。
