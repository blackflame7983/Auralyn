---
name: code-review-expert
description: コードの変更に対して、SOLID原則、アーキテクチャ、削除候補、セキュリティリスクに焦点を当てた構造的なレビューを行います。
---

# コードレビュー・エキスパート (Code Review Expert)

## 概要
SOLID原則、アーキテクチャ、不要コードの削除、セキュリティリスクに焦点を当てて、現在のGitの変更を体系的にレビューします。ユーザーが実装を求めない限り、レビュー出力のみをデフォルトとします。

## 重要度レベル (Severity Levels)
| レベル | 名前 | 説明 | アクション |
|-------|------|-------------|--------|
| **P0** | Critical | セキュリティ脆弱性、データ損失リスク、正確性のバグ | マージをブロックする必要があります |
| **P1** | High | ロジックエラー、重大なSOLID違反、パフォーマンス低下 | マージ前に修正すべきです |
| **P2** | Medium | コードの臭い、保守性の懸念、軽微なSOLID違反 | このPRで修正するか、フォローアップを作成します |
| **P3** | Low | スタイル、命名、軽微な提案 | 任意の改善 |

## ワークフロー
### 1) プレフライト・コンテキスト
- `git status -sb`, `git diff --stat`, `git diff` を使用して変更範囲を確認します。
- 必要に応じて `rg` や `grep` を使用して、関連モジュール、使用箇所、契約を見つけます。
- エントリポイント、所有権の境界、クリティカルパス（認証、支払い、データ書き込み、ネットワーク）を特定します。

### 2) SOLID + アーキテクチャの臭い
- **SRP**: 無関係な責任を持つ過負荷なモジュール。
- **OCP**: 拡張ポイントではなく、動作を追加するために頻繁に編集される箇所。
- **LSP**: 期待を裏切る、または型チェックを必要とするサブクラス。
- **ISP**: 未使用のメソッドを持つ広いインターフェース。
- **DIP**: 低レベルの実装に結合された高レベルのロジック。

### 3) 削除候補 + 反復計画
- 未使用、冗長、または機能フラグでオフになっているコードを特定します。
- **今すぐ安全に削除** vs **計画付きで延期** を区別します。

### 4) セキュリティと信頼性のスキャン
- インジェクション (SQL/NoSQL/コマンド)、XSS、SSRF、パストラバーサル
- AuthZ/AuthN のギャップ、テナンシーチェックの欠落
- ログ/env/ファイル内の秘密漏洩
- レート制限、無限ループ、CPU/メモリのホットスポット
- 不安全なデシリアライズ、弱い暗号化、安全でないデフォルト
- **競合状態**: 同時アクセス、check-then-act

### 5) コード品質スキャン
- **エラー処理**: 飲み込まれた例外、広すぎるキャッチ、欠落したエラー処理
- **パフォーマンス**: N+1クエリ、ホットパスでのCPU集約的な操作
- **境界条件**: null/undefined処理、空のコレクション

### 6) 出力フォーマット
レビューを以下のように構成します：

```markdown
## コードレビュー概要

**レビューしたファイル**: X ファイル, Y 行の変更
**総合評価**: [承認 / 変更要求 / コメント]

---

## 発見事項

### P0 - Critical
(なし または リスト)

### P1 - High
- **[file:line]** 短いタイトル
  - 問題の説明
  - 提案される修正

### P2 - Medium
...

---

## 削除/反復計画
(該当する場合)

## 追加の提案
(任意の改善、ブロックしない)
```

### 7) 次のステップの確認
所見を提示した後、どのように進めるかユーザーに尋ねます：
1. **すべて修正**: 提案された修正をすべて実装します
2. **P0/P1のみ修正**: クリティカルおよび高優先度の問題に対処します
3. **特定の項目を修正**: 修正する問題を指示してください
4. **変更なし**: レビュー完了、実装は不要です
